# builder

[src/main_build.cpp](src/main_build.cpp)

My .bat files to invoke compilation/linking/etc were growing out of control, so I consolidated all the logic into one .exe

One of the core ideas here was to bake the config into the source code itself, so all I have to do to invoke a build is run the tiniest of build scripts, b.bat. What this means is, I've defined a comment line of code syntax that has to be present as the first line of code in the uber sourcefile we're building. There's different configurations of what you can set that line to, but the basic idea is to have this build tool load up the primary sourcefile, read the first line, and use the given config. I can definitely do a better job here, this is the bare minimum. But I don't really need more than that right now.

One thing that's super annoying in most generic makefile systems is that you can't do arbitrary things easily. But since this is just an .exe, we can do whatever. Check for system setup problems, toolchain installs, etc. And we don't need to use some underpowered language to do so, that has horrible error messages.

Another powerful thing here is showing how to avoid the slow startup cost of vcvarsall.bat and similar VS command setup scripts. Usually that takes >1 second to run, which is pretty terrible considering the net effect is to setup environment variables corresponding to the VS install that you have. The way to speed this up is to take note of all the environment variables actually set by those scripts at one particular VS install, copy them down, and then set them yourself. The OS API to set the enviroment variables is really fast as you'd expect, so we can just set it ourselves here in this build runner process. Then whenever we create child CL.exe or LINK.exe processes, they'll automatically inherit the environment variables, and we don't pay any cost. These environment settings only apply to this build runner process and it's children, which is the perfect scoping; not too long, not too short. However, this has the relatively ugly downside of needing to repeat this monitoring of what variables vcvarsall.bat will set, whenever you update / upgrade VS. But since I do that so infrequently, this is a great option for me. I could also build an environment diff tool that outputs what variables vcvarsall.bat sets, so I don't have to do it manually. Maybe I'll do that next time I update VS.

One funny thing is that since I use this build runner for all my usual builds, that leads to the circular problem of how do I build the builder? Instead of a "self-host" approach now that I've got a functional builder, I've just got a simple bootstrap.bat that does the minimal, suboptimally-configured build of this builder. Since it's a simple enough program, it shouldn't need a bunch of complexity to build it. And it's nice to always have a definitive way of making it safely from source, not having to keep an old copy of source code around for debugging when things go wrong.
